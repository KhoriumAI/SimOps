# SimOps Online Deployment
# Uses pre-built images from GHCR + Watchtower for auto-updates

x-common-env: &common-env
  REDIS_HOST: redis
  REDIS_PORT: 6379
  # For online install, use relative paths created by install script
  INPUT_DIR: /input
  OUTPUT_DIR: /output
  LOG_LEVEL: INFO
  TZ: America/Los_Angeles

services:
  # =================================================================
  # AUTO-UPDATER (Watchtower)
  # =================================================================
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Check every hour, remove old images, include restarting containers
    command: --interval 3600 --cleanup --include-restarting
    restart: always

  # =================================================================
  # CORE SERVICES
  # =================================================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  worker:
    image: ghcr.io/khoriumai/simops-worker:latest
    depends_on:
      - redis
    environment:
      <<: *common-env
      WORKER_TIMEOUT: 1800
    volumes:
      - ./logs:/logs
    deploy:
      mode: replicated
      replicas: 4
      resources:
        limits:
          cpus: '2'
          memory: 4G
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  dashboard:
    image: eoranged/rq-dashboard:latest
    depends_on:
      - redis
    ports:
      - "${DASHBOARD_PORT:-9181}:9181"
    environment:
      RQ_DASHBOARD_REDIS_URL: redis://redis:6379
    restart: unless-stopped

  # =================================================================
  # WEB UI & API (Custom User UI)
  # =================================================================
  api:
    image: ghcr.io/khoriumai/simops-api:latest
    depends_on:
      - redis
    environment:
      <<: *common-env
      FLASK_ENV: production
    ports:
      - "${API_PORT:-3001}:3000"
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  frontend:
    image: ghcr.io/khoriumai/simops-frontend:latest
    depends_on:
      - api
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  redis_data:

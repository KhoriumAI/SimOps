version: '3.8'

services:
  # ============================================================================
  # CORE SERVICES
  # ============================================================================
  backend:
    image: ghcr.io/khorium/simops-backend:latest
    container_name: simops-backend
    restart: always
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - UPLOAD_FOLDER=/app/uploads
    volumes:
      - simops_uploads:/app/uploads
    depends_on:
      - redis

  frontend:
    image: ghcr.io/khorium/simops-frontend:latest
    container_name: simops-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    depends_on:
      - backend

  worker:
    image: ghcr.io/khorium/simops-worker:latest
    container_name: simops-worker
    restart: always
    environment:
      - REDIS_URL=redis://redis:6379/0
      - BACKEND_URL=http://backend:5000
    volumes:
      - simops_uploads:/app/uploads
    deploy:
      replicas: 1
    depends_on:
      - redis
      - backend

  # ============================================================================
  # INFRASTRUCTURE
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: simops-redis
    restart: always
    volumes:
      - simops_redis_data:/data

  dashboard:
    image: cjlapao/rq-dashboard:latest
    container_name: simops-dashboard
    restart: always
    ports:
      - "${DASHBOARD_PORT:-9181}:9181"
    environment:
      - REDIS_URL=redis://redis:6379/0

  # ============================================================================
  # AUTO-UPDATER (WATCHTOWER)
  # ============================================================================
  watchtower:
    image: containrrr/watchtower
    container_name: simops-updater
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup --label-enable=false # Check every hour, cleanup old images
    environment:
      - WATCHTOWER_INCLUDE_RESTARTING=true
    # Note: By default, Watchtower watches all containers.
    # If we wanted to restrict it, we'd use --label-enable and add labels to services.

volumes:
  simops_uploads:
  simops_redis_data:

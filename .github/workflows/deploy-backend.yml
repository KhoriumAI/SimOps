# Deploy Backend to EC2
# Triggers on push to main branch when backend files change

name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "apps/**"
      - "core/**"
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            
            echo "[DEPLOY] Navigating to backend directory..."
            cd /home/ec2-user/backend || { echo "[ERROR] Failed to cd to /home/ec2-user/backend"; exit 1; }
            
            echo "[DEPLOY] Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            git log --oneline -1
            
            echo "[DEPLOY] Activating virtual environment..."
            source venv/bin/activate || { echo "[ERROR] Failed to activate venv"; exit 1; }
            which python
            
            echo "[DEPLOY] Installing dependencies..."
            pip install -r backend/requirements.txt 2>&1 || { echo "[ERROR] pip install failed"; exit 1; }
            
            echo "[DEPLOY] Killing any processes on port 3000..."
            sudo fuser -k 3000/tcp 2>/dev/null || true
            
            echo "[DEPLOY] Restarting gunicorn service..."
            sudo systemctl restart gunicorn || sudo systemctl start gunicorn
            
            echo "[DEPLOY] Waiting for service to start..."
            sleep 3
            
            echo "[DEPLOY] Checking gunicorn status..."
            sudo systemctl status gunicorn --no-pager || true
            
            echo "[OK] Backend deployed successfully!"

      - name: Health Check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "[HEALTH] Waiting for service to fully start..."
            sleep 5
            
            echo "[HEALTH] Checking what is listening on port 3000..."
            sudo netstat -tlnp | grep 3000 || echo "[WARNING] Nothing listening on port 3000!"
            
            echo "[HEALTH] Running health check..."
            if curl -sf http://localhost:3000/api/health; then
              echo ""
              echo "[OK] Health check passed!"
            else
              echo "[ERROR] Health check failed!"
              echo "[DEBUG] Recent gunicorn logs:"
              sudo journalctl -u gunicorn -n 20 --no-pager || true
              exit 1
            fi
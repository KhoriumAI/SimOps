# Deploy Backend to EC2 via AWS SSM
# Triggers on push to main branch when backend files change

name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "apps/**"
      - "core/**"
      - ".github/workflows/deploy-backend.yml"
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --instance-ids "i-0bdb1e0eaa658cc7c" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy backend via GitHub Actions (SSM)" \
            --parameters '{
              "commands": [
                "echo \"[DEPLOY] Updating permissions...\"",
                "sudo chown -R ec2-user:ec2-user /home/ec2-user/backend",
                "echo \"[DEPLOY] Configuring git...\"",
                "runuser -l ec2-user -c \"git config --global --add safe.directory /home/ec2-user/backend\"",
                "echo \"[DEPLOY] Pulling latest code...\"",
                "runuser -l ec2-user -c \"cd /home/ec2-user/backend && git fetch --all && git reset --hard origin/main\"",
                "echo \"[DEPLOY] Installing dependencies...\"",
                "runuser -l ec2-user -c \"cd /home/ec2-user/backend && venv/bin/pip install -r backend/requirements.txt\"",
                "echo \"[DEPLOY] Running migrations...\"",
                "runuser -l ec2-user -c \"cd /home/ec2-user/backend && venv/bin/python backend/run_migration.py\"",
                "echo \"[DEPLOY] Restarting gunicorn...\"",
                "sudo systemctl restart gunicorn",
                "echo \"[DEPLOY] Waiting for service to start...\"",
                "sleep 5",
                "echo \"[DEPLOY] Health check...\"",
                "curl -sf http://localhost:3000/api/health || (echo \"[ERROR] Health check failed\" && sudo journalctl -u gunicorn -n 20 --no-pager && exit 1)"
              ]
            }' \
            --region us-west-1
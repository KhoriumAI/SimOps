# Modal Webhooks & WebSocket API

This document describes the integration between Modal (compute backend), the Flask API server, and the React frontend for real-time mesh generation updates.

## Webhooks

The backend provides a webhook endpoint to receive notifications from Modal jobs upon completion or failure.

### Endpoint: `POST /api/webhooks/modal`

**Authentication**: Required via HMAC-SHA256 signature in the `X-Modal-Signature` header.

**Payload Schema**:
```json
{
    "job_id": "modal-job-id",
    "status": "completed" | "failed",
    "result": {
        "success": true,
        "s3_output_path": "s3://bucket/path/to/mesh.msh",
        "strategy": "Tetrahedral (Delaunay)",
        "quality_metrics": {
            "sicn_avg": 0.85,
            "total_elements": 125032
        },
        "metrics": {
            "total_time_seconds": 45.2
        }
    },
    "error": "Error message if failed"
}
```

### Signature Verification
The `X-Modal-Signature` header contains an HMAC-SHA256 hash of the raw request body, signed using the `MODAL_WEBHOOK_SECRET`.
Format: `sha256=<hash>`

## WebSockets

Real-time updates are provided via `Flask-SocketIO`.

### Events

#### 1. Log Streaming (`log_line`)
Emitted as logs are generated by the mesh worker.
- **Room**: `project_<project_id>`
- **Payload**:
```json
{
    "job_id": "job-uuid",
    "message": "Log message text",
    "timestamp": "ISO-8601"
}
```

#### 2. Job Progress (`job_progress`)
Emitted during batch processing or single jobs.
- **Room**: `batch_<batch_id>` or `project_<project_id>`
- **Payload**:
```json
{
    "batch_id": "batch-uuid",
    "job_id": "job-uuid",
    "progress": 45,
    "status": "processing",
    "message": "Current activity"
}
```

#### 3. Batch Status (`batch_status`)
Emitted when a batch changes state.
- **Room**: `batch_<batch_id>`
- **Payload**:
```json
{
    "batch_id": "batch-uuid",
    "status": "completed" | "failed" | "processing",
    "completed_jobs": 5,
    "total_jobs": 10
}
```

#### 4. Job Completion (`job_completed` / `job_failed`)
Emitted when a single job finishes.
- **Room**: `project_<project_id>`
- **Payload (`job_completed`)**:
```json
{
    "project_id": "project-uuid",
    "job_id": "job-id",
    "status": "completed",
    "result": { ... MeshResult to_dict() ... }
}
```

## How to Test

### Mock Webhook
You can simulate a Modal webhook call using `curl`:
```bash
curl -X POST http://localhost:5000/api/webhooks/modal \
  -H "Content-Type: application/json" \
  -H "X-Modal-Signature: sha256=MOCKED_SIGNATURE_IF_SECRET_NOT_SET" \
  -d '{"job_id": "test-job", "status": "completed", "result": {"success": true}}'
```
*(Note: If `MODAL_WEBHOOK_SECRET` is not set in development, verification is skipped with a warning)*.
